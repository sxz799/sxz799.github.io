---
title: 蜗牛星际之安装PVE+LEDE+群辉
copyright: true
date: 2019-04-06 19:54:28
tags:
- 软路由
- 虚拟机
- LEDE
- PVE
categories:
- 总结
comments:
password:
---

## 前言
上次安装了LEDE软路由后，也挂载了一个500G的硬盘，但总感觉对于J1900+4G内存来说有点浪费，还有那么大哥机箱，如果不做NAS有点对不起他的体积，在加上本来就是个矿机就尽量多压榨一下他的性能。
这里只是简单些一下安装流程，不打算上传图片了，更加详细的教程可以看下面的链接
[蜗牛矿渣装机教程 篇一：搞定PVE虚拟机](https://post.smzdm.com/p/ag89qdw6/)作者主页有更多的教程，一共四个系列。

## 一、准备
### 1.规划IP地址
按照自己的需求规划好IP地址，尽量用纸记下来，省的以后乱套。

建议将PVE地址规划为软路由lan口的子网地址 例如192.168.123.100

群辉地址也为lan口的子网地址 例如192.168.123.102(这里的102是PVE的虚拟机序号，默认是从100开始)

### 2.制作U盘启动
两个优盘，一个装PE，一个装PVE镜像

1. PE直接用老毛桃即可。

2. 用win32磁盘映像工具将pve的iso镜像写入U盘

### 3.恢复bios默认设置
开机接键盘后按del进去bios，然后按F9恢复默认设置，然后F10保存并退出。

## 二、安装PVE
1. 插入老毛桃优盘进入PE，进入后将内置16G的mSATA所有分区删除，然后建立一个新分区。NTFS格式，取消勾选ESP和EFI。

2. 关机，拔出老毛桃U盘，插入刻录PVE镜像的优盘启动盘。

3. 开机按F11选择UEFI开头的U盘，进入PVE安装界面	

4. 根据指示安装完成即可。(这里会提示设置PVE的IP地址、子网掩码和网关)

5. 添加网卡桥接，默认只有一个桥接网卡，按照格式添加新的桥接网卡即可。建议备注好WAN和LAN口。因为蜗牛只有2个网卡，所以备注好WAN和LAN同时在机箱后备注好WAN和LAN。

## 三、安装LEDE
1. 新建虚拟机，选择不适用任何介质，硬盘分配1G-2G即可(后面远程连接需要安装docker，所以分配够用即可)，合理配置内存与核心（1G+4cores），网卡选择E1000。

2. 下载LEDE镜像并解压。

3. 将img2kvm和解压后的镜像上传到PVE的root目录

4. root目录下指令下面命令(Linux系统当前用户目录显示为~)

```
chmod +x img2kvm
./img2kvm lede.img 101(虚拟机编号) lede-leader-disk(这里可以自定义的)
```
5. 在虚拟机的硬件页面添加新建的磁盘文件，硬盘接口尽量选择sata

6. 硬件添加一个新的网卡。

7. 在选项页面调整启动顺序，将新加的文件设置为第一引导

8. 启动虚拟机，并在控制台修改LAN口IP,然后reboot即可。

## 四、安装群辉
1. 和LEDE类似，新建虚拟机，硬盘分配4G以上，配置为3G+4cores,网卡选择E1000。

2. 同样的方法挂载引导磁盘，控制器一定要选SATA，不然无法获取IP.
3. 调整启动顺序，将引导磁盘设置为第一启动项。

4. 下载群辉助手，搜索，安装即可。(这一步用群辉助手搜索即可，可以挂载好硬盘再安装。)
5. 如果搜索不到的话看一下本机IP是否在LEDE分配的网段下，因为的我网络环境是光猫拨号，直接获取到光猫分配的IP，导致无法搜索，建议在断网的环境下安装群辉。

## 五、群辉挂载磁盘

1. 关闭群辉虚拟机

2. 插入硬盘

3. 用下面的命令查看硬盘名称
```
cd /dev/disk/by-id
ls
```

4. 复制磁盘名

5. 用下面的命令挂载到群辉虚拟机
   `qm set 102(群辉ID) -sataX(X为序列号，不可与之前的重复) /dev/disk/by-id/XXXXX(XXXX为硬盘名称)`
6. 挂载好以后可以将之前的4G虚拟硬盘分离，然后删除即可。

## 总结
1. 一定要提前规划好IP

2. 群辉引导一定要选择SATA.

3. 群辉洗白可以挂载一个ISO格式PE镜像，作为第一引导，在控制台页面修改sn和mac即可。

4. 当LEDE作为二级路由，即WAN口协议为DHCP客户端时，要在LAN口的DHCP服务器高级设置中勾选‘强制’ //即使检测到另一台服务器，也要强制使用此网络上的 DHCP。